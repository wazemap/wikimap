<!DOCTYPE html>
<html>
<head>
<title>Wiki-Show</title>
<style type=text/css>html{height:100%}body{height:100%;margin:0;padding:0}#map-canvas{height:100%}</style>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js></script>
<link rel=stylesheet href=https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css>
<script type=text/javascript src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC_W06HWx07AZNct8vaNB1aPnMzAZzdYqM&libraries=geometry,places"></script>
<script type=text/javascript src=https://rawgit.com/googlemaps/v3-utility-library/master/markerclustererplus/src/markerclusterer.js></script>
<script type=text/javascript>var ajaxQueue=new Array();var locationMarker=null;function initialize(){if(!myPos){myPos=new google.maps.LatLng(0,0)}var c={center:myPos,zoom:15,maxZoom:18};var a;a=new google.maps.Map(document.getElementById("map-canvas"),c);var m=new MarkerClusterer(a,null,{gridSize:20,imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"});locationMarker=new google.maps.Marker({position:myPos,map:a,title:"Current Location"});var f=new google.maps.InfoWindow({content:"empty"});function o(p,s){p.style.padding="5px";var r=document.createElement("div");r.style.backgroundColor="white";r.style.borderStyle="solid";r.style.borderWidth="2px";r.style.cursor="pointer";r.style.textAlign="center";r.title="Click to set the map to your current location";p.appendChild(r);var q=document.createElement("div");q.style.fontFamily="Arial,sans-serif";q.style.fontSize="18px";q.style.paddingLeft="4px";q.style.paddingRight="4px";q.innerHTML="<b>Center</b>";r.appendChild(q);google.maps.event.addDomListener(r,"click",function(){if(locationMarker!=null){s.setCenter(locationMarker.position)}else{alert("error")}})}var b=document.createElement("div");var i=new o(b,a);b.index=1;a.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(b);var n=new Object();google.maps.event.addListener(m,"click",function(p){if(a.getZoom()==a.maxZoom){e=p.getMarkers();articleArray=new Array();$.each(e,function(q,r){articleArray.push(n[r.id])});f.close();f.setContent(l(articleArray));f.setPosition(p.getCenter());f.open(a,null)}});function l(p){html="";$.each(p,function(q,r){html+='<a href="'+r.url+'" target="_blank"> <h2>'+r.title+"</h2></a>"});return html}function h(w,t,q,u,p,v){if(n[w]==null){var s={url:"https://cdn.rawgit.com/wazemap/wikimap/master/wikimarker.png",size:new google.maps.Size(50,50)};var r=new google.maps.LatLng(t,q);n[w]=new Object();n[w].url=p;n[w].title=u;n[w].marker=new google.maps.Marker({position:r,icon:s,title:u,animation:google.maps.Animation.DROP,id:w});m.addMarker(n[w].marker);google.maps.event.addListener(n[w].marker,"click",function(){f.setContent(l(new Array(n[this.id])));f.open(a,this)})}else{console.log("Article already added... skipping")}}var e=[];function d(p,q){diagonal=google.maps.geometry.spherical.computeDistanceBetween(p.getNorthEast(),p.getSouthWest());center=p.getCenter();if(diagonal>10000){diagonal=10000}requestURL=urlDomain+"/w/api.php?format=json&action=query&list=geosearch&gsradius="+diagonal+"&gscoord="+center.lat()+"|"+center.lng()+"&gslimit=500&callback=?&continue=";console.log("Request is for "+requestURL);ajaxQueue.push($.getJSON(requestURL,function(r){j(r,p)}))}function g(){$.each(ajaxQueue,function(p,q){q.abort();q=null});ajaxQueue=new Array()}function k(){m.clearMarkers()}function j(p,q){console.log(p);$.each(p.query.geosearch,function(t,u){var y=u.pageid;var w=u.title;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){var s=urlDomainMobile+"/?curid="+y}else{var s=urlDomain+"/?curid="+y}var v=u.lat;var r=u.lon;var x=u.dist;h(y,v,r,w,s,x)})}google.maps.event.addListener(a,"idle",function(){g();console.log("moved");bounds=a.getBounds();center=bounds.getCenter();d(bounds,0)})}</script>
<style>html,body,#map-canvas{height:100%;margin:0;padding:0}</style>
</head>
<script>function getURLParameter(a){var d=window.location.search.substring(1);var c=d.split("&");for(var b=0;b<c.length;b++){var e=c[b].split("=");if(e[0]==a){return e[1]}}}</script>
<script>$(document).ready(function(){var c=getURLParameter("locale");var b=getURLParameter("lat");var a=getURLParameter("lng");if(!c){c="en"}if(!b){b="40.6892746"}if(!a){a="-74.04455589"}myPos=new google.maps.LatLng(b,a);urlDomain="http://"+c+".wikipedia.org";urlDomainMobile="http://"+c+".m.wikipedia.org";initialize()});</script>
<body>
<div id=map-canvas></div>
</body>
</html>